{"ast":null,"code":"const EventEmitter = require('events').EventEmitter;\n\nconst inherits = require('util').inherits;\n\nconst ethUtil = require('ethereumjs-util');\n\nconst EthBlockTracker = require('eth-block-tracker');\n\nconst map = require('async/map');\n\nconst eachSeries = require('async/eachSeries');\n\nconst Stoplight = require('./util/stoplight.js');\n\nconst cacheUtils = require('./util/rpc-cache-utils.js');\n\nconst createPayload = require('./util/create-payload.js');\n\nconst noop = function () {};\n\nmodule.exports = Web3ProviderEngine;\ninherits(Web3ProviderEngine, EventEmitter);\n\nfunction Web3ProviderEngine(opts) {\n  const self = this;\n  EventEmitter.call(self);\n  self.setMaxListeners(30); // parse options\n\n  opts = opts || {}; // block polling\n\n  const directProvider = {\n    sendAsync: self._handleAsync.bind(self)\n  };\n  const blockTrackerProvider = opts.blockTrackerProvider || directProvider;\n  self._blockTracker = opts.blockTracker || new EthBlockTracker({\n    provider: blockTrackerProvider,\n    pollingInterval: opts.pollingInterval || 4000,\n    setSkipCacheFlag: true\n  }); // set initialization blocker\n\n  self._ready = new Stoplight(); // local state\n\n  self.currentBlock = null;\n  self._providers = [];\n} // public\n\n\nWeb3ProviderEngine.prototype.start = function (cb = noop) {\n  const self = this; // trigger start\n\n  self._ready.go(); // on new block, request block body and emit as events\n\n\n  self._blockTracker.on('latest', blockNumber => {\n    // get block body\n    self._getBlockByNumberWithRetry(blockNumber, (err, block) => {\n      if (err) {\n        this.emit('error', err);\n        return;\n      }\n\n      if (!block) {\n        console.log(block);\n        this.emit('error', new Error(\"Could not find block\"));\n        return;\n      }\n\n      const bufferBlock = toBufferBlock(block); // set current + emit \"block\" event\n\n      self._setCurrentBlock(bufferBlock); // emit other events\n\n\n      self.emit('rawBlock', block);\n      self.emit('latest', block);\n    });\n  }); // forward other events\n\n\n  self._blockTracker.on('sync', self.emit.bind(self, 'sync'));\n\n  self._blockTracker.on('error', self.emit.bind(self, 'error')); // update state\n\n\n  self._running = true; // signal that we started\n\n  self.emit('start');\n};\n\nWeb3ProviderEngine.prototype.stop = function () {\n  const self = this; // stop block polling by removing event listeners\n\n  self._blockTracker.removeAllListeners(); // update state\n\n\n  self._running = false; // signal that we stopped\n\n  self.emit('stop');\n};\n\nWeb3ProviderEngine.prototype.isRunning = function () {\n  const self = this;\n  return self._running;\n};\n\nWeb3ProviderEngine.prototype.addProvider = function (source, index) {\n  const self = this;\n\n  if (typeof index === 'number') {\n    self._providers.splice(index, 0, source);\n  } else {\n    self._providers.push(source);\n  }\n\n  source.setEngine(this);\n};\n\nWeb3ProviderEngine.prototype.removeProvider = function (source) {\n  const self = this;\n\n  const index = self._providers.indexOf(source);\n\n  if (index < 0) throw new Error('Provider not found.');\n\n  self._providers.splice(index, 1);\n};\n\nWeb3ProviderEngine.prototype.send = function (payload) {\n  throw new Error('Web3ProviderEngine does not support synchronous requests.');\n};\n\nWeb3ProviderEngine.prototype.sendAsync = function (payload, cb) {\n  const self = this;\n\n  self._ready.await(function () {\n    if (Array.isArray(payload)) {\n      // handle batch\n      map(payload, self._handleAsync.bind(self), cb);\n    } else {\n      // handle single\n      self._handleAsync(payload, cb);\n    }\n  });\n}; // private\n\n\nWeb3ProviderEngine.prototype._getBlockByNumberWithRetry = function (blockNumber, cb) {\n  const self = this;\n  let retriesRemaining = 5;\n  attemptRequest();\n  return;\n\n  function attemptRequest() {\n    self._getBlockByNumber(blockNumber, afterRequest);\n  }\n\n  function afterRequest(err, block) {\n    // anomalous error occurred\n    if (err) return cb(err); // block not ready yet\n\n    if (!block) {\n      if (retriesRemaining > 0) {\n        // wait 1s then try again\n        retriesRemaining--;\n        setTimeout(function () {\n          attemptRequest();\n        }, 1000);\n        return;\n      } else {\n        // give up, return a null block\n        cb(null, null);\n        return;\n      }\n    } // otherwise return result\n\n\n    cb(null, block);\n    return;\n  }\n};\n\nWeb3ProviderEngine.prototype._getBlockByNumber = function (blockNumber, cb) {\n  const req = createPayload({\n    method: 'eth_getBlockByNumber',\n    params: [blockNumber, false],\n    skipCache: true\n  });\n\n  this._handleAsync(req, (err, res) => {\n    if (err) return cb(err);\n    return cb(null, res.result);\n  });\n};\n\nWeb3ProviderEngine.prototype._handleAsync = function (payload, finished) {\n  var self = this;\n  var currentProvider = -1;\n  var result = null;\n  var error = null;\n  var stack = [];\n  next();\n\n  function next(after) {\n    currentProvider += 1;\n    stack.unshift(after); // Bubbled down as far as we could go, and the request wasn't\n    // handled. Return an error.\n\n    if (currentProvider >= self._providers.length) {\n      end(new Error('Request for method \"' + payload.method + '\" not handled by any subprovider. Please check your subprovider configuration to ensure this method is handled.'));\n    } else {\n      try {\n        var provider = self._providers[currentProvider];\n        provider.handleRequest(payload, next, end);\n      } catch (e) {\n        end(e);\n      }\n    }\n  }\n\n  function end(_error, _result) {\n    error = _error;\n    result = _result;\n    eachSeries(stack, function (fn, callback) {\n      if (fn) {\n        fn(error, result, callback);\n      } else {\n        callback();\n      }\n    }, function () {\n      var resultObj = {\n        id: payload.id,\n        jsonrpc: payload.jsonrpc,\n        result: result\n      };\n\n      if (error != null) {\n        resultObj.error = {\n          message: error.stack || error.message || error,\n          code: -32000\n        }; // respond with both error formats\n\n        finished(error, resultObj);\n      } else {\n        finished(null, resultObj);\n      }\n    });\n  }\n}; //\n// from remote-data\n//\n\n\nWeb3ProviderEngine.prototype._setCurrentBlock = function (block) {\n  const self = this;\n  self.currentBlock = block;\n  self.emit('block', block);\n}; // util\n\n\nfunction toBufferBlock(jsonBlock) {\n  return {\n    number: ethUtil.toBuffer(jsonBlock.number),\n    hash: ethUtil.toBuffer(jsonBlock.hash),\n    parentHash: ethUtil.toBuffer(jsonBlock.parentHash),\n    nonce: ethUtil.toBuffer(jsonBlock.nonce),\n    mixHash: ethUtil.toBuffer(jsonBlock.mixHash),\n    sha3Uncles: ethUtil.toBuffer(jsonBlock.sha3Uncles),\n    logsBloom: ethUtil.toBuffer(jsonBlock.logsBloom),\n    transactionsRoot: ethUtil.toBuffer(jsonBlock.transactionsRoot),\n    stateRoot: ethUtil.toBuffer(jsonBlock.stateRoot),\n    receiptsRoot: ethUtil.toBuffer(jsonBlock.receiptRoot || jsonBlock.receiptsRoot),\n    miner: ethUtil.toBuffer(jsonBlock.miner),\n    difficulty: ethUtil.toBuffer(jsonBlock.difficulty),\n    totalDifficulty: ethUtil.toBuffer(jsonBlock.totalDifficulty),\n    size: ethUtil.toBuffer(jsonBlock.size),\n    extraData: ethUtil.toBuffer(jsonBlock.extraData),\n    gasLimit: ethUtil.toBuffer(jsonBlock.gasLimit),\n    gasUsed: ethUtil.toBuffer(jsonBlock.gasUsed),\n    timestamp: ethUtil.toBuffer(jsonBlock.timestamp),\n    transactions: jsonBlock.transactions\n  };\n}","map":{"version":3,"sources":["/home/ryann/Documents/Repos/ChainSafe/chainbridge-ui/node_modules/web3-provider-engine/index.js"],"names":["EventEmitter","require","inherits","ethUtil","EthBlockTracker","map","eachSeries","Stoplight","cacheUtils","createPayload","noop","module","exports","Web3ProviderEngine","opts","self","call","setMaxListeners","directProvider","sendAsync","_handleAsync","bind","blockTrackerProvider","_blockTracker","blockTracker","provider","pollingInterval","setSkipCacheFlag","_ready","currentBlock","_providers","prototype","start","cb","go","on","blockNumber","_getBlockByNumberWithRetry","err","block","emit","console","log","Error","bufferBlock","toBufferBlock","_setCurrentBlock","_running","stop","removeAllListeners","isRunning","addProvider","source","index","splice","push","setEngine","removeProvider","indexOf","send","payload","await","Array","isArray","retriesRemaining","attemptRequest","_getBlockByNumber","afterRequest","setTimeout","req","method","params","skipCache","res","result","finished","currentProvider","error","stack","next","after","unshift","length","end","handleRequest","e","_error","_result","fn","callback","resultObj","id","jsonrpc","message","code","jsonBlock","number","toBuffer","hash","parentHash","nonce","mixHash","sha3Uncles","logsBloom","transactionsRoot","stateRoot","receiptsRoot","receiptRoot","miner","difficulty","totalDifficulty","size","extraData","gasLimit","gasUsed","timestamp","transactions"],"mappings":"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","sourcesContent":["const EventEmitter = require('events').EventEmitter\nconst inherits = require('util').inherits\nconst ethUtil = require('ethereumjs-util')\nconst EthBlockTracker = require('eth-block-tracker')\nconst map = require('async/map')\nconst eachSeries = require('async/eachSeries')\nconst Stoplight = require('./util/stoplight.js')\nconst cacheUtils = require('./util/rpc-cache-utils.js')\nconst createPayload = require('./util/create-payload.js')\nconst noop = function(){}\n\nmodule.exports = Web3ProviderEngine\n\n\ninherits(Web3ProviderEngine, EventEmitter)\n\nfunction Web3ProviderEngine(opts) {\n  const self = this\n  EventEmitter.call(self)\n  self.setMaxListeners(30)\n  // parse options\n  opts = opts || {}\n\n  // block polling\n  const directProvider = { sendAsync: self._handleAsync.bind(self) }\n  const blockTrackerProvider = opts.blockTrackerProvider || directProvider\n  self._blockTracker = opts.blockTracker || new EthBlockTracker({\n    provider: blockTrackerProvider,\n    pollingInterval: opts.pollingInterval || 4000,\n    setSkipCacheFlag: true,\n  })\n\n  // set initialization blocker\n  self._ready = new Stoplight()\n\n  // local state\n  self.currentBlock = null\n  self._providers = []\n}\n\n// public\n\nWeb3ProviderEngine.prototype.start = function(cb = noop){\n  const self = this\n\n  // trigger start\n  self._ready.go()\n\n  // on new block, request block body and emit as events\n  self._blockTracker.on('latest', (blockNumber) => {\n    // get block body\n    self._getBlockByNumberWithRetry(blockNumber, (err, block) => {\n      if (err) {\n        this.emit('error', err)\n        return\n      }\n      if (!block) {\n        console.log(block)\n        this.emit('error', new Error(\"Could not find block\"))\n        return\n      }\n      const bufferBlock = toBufferBlock(block)\n      // set current + emit \"block\" event\n      self._setCurrentBlock(bufferBlock)\n      // emit other events\n      self.emit('rawBlock', block)\n      self.emit('latest', block)\n    })\n  })\n\n  // forward other events\n  self._blockTracker.on('sync', self.emit.bind(self, 'sync'))\n  self._blockTracker.on('error', self.emit.bind(self, 'error'))\n\n  // update state\n  self._running = true\n  // signal that we started\n  self.emit('start')\n}\n\nWeb3ProviderEngine.prototype.stop = function(){\n  const self = this\n  // stop block polling by removing event listeners\n  self._blockTracker.removeAllListeners()\n  // update state\n  self._running = false\n  // signal that we stopped\n  self.emit('stop')\n}\n\nWeb3ProviderEngine.prototype.isRunning = function(){\n  const self = this\n  return self._running\n}\n\nWeb3ProviderEngine.prototype.addProvider = function(source, index){\n  const self = this\n  if (typeof index === 'number') {\n    self._providers.splice(index, 0, source)\n  } else {\n    self._providers.push(source)\n  }\n  source.setEngine(this)\n}\n\nWeb3ProviderEngine.prototype.removeProvider = function(source){\n  const self = this\n  const index = self._providers.indexOf(source)\n  if (index < 0) throw new Error('Provider not found.')\n  self._providers.splice(index, 1)\n}\n\nWeb3ProviderEngine.prototype.send = function(payload){\n  throw new Error('Web3ProviderEngine does not support synchronous requests.')\n}\n\nWeb3ProviderEngine.prototype.sendAsync = function(payload, cb){\n  const self = this\n  self._ready.await(function(){\n\n    if (Array.isArray(payload)) {\n      // handle batch\n      map(payload, self._handleAsync.bind(self), cb)\n    } else {\n      // handle single\n      self._handleAsync(payload, cb)\n    }\n\n  })\n}\n\n// private\n\nWeb3ProviderEngine.prototype._getBlockByNumberWithRetry = function(blockNumber, cb) {\n  const self = this\n\n  let retriesRemaining = 5\n\n  attemptRequest()\n  return\n\n  function attemptRequest () {\n    self._getBlockByNumber(blockNumber, afterRequest)\n  }\n\n  function afterRequest (err, block) {\n    // anomalous error occurred\n    if (err) return cb(err)\n    // block not ready yet\n    if (!block) {\n      if (retriesRemaining > 0) {\n        // wait 1s then try again\n        retriesRemaining--\n        setTimeout(function () {\n          attemptRequest()\n        }, 1000)\n        return\n      } else {\n        // give up, return a null block\n        cb(null, null)\n        return\n      }\n    }\n    // otherwise return result\n    cb(null, block)\n    return\n  }\n}\n\n\nWeb3ProviderEngine.prototype._getBlockByNumber = function(blockNumber, cb) {\n  const req = createPayload({ method: 'eth_getBlockByNumber', params: [blockNumber, false], skipCache: true })\n  this._handleAsync(req, (err, res) => {\n    if (err) return cb(err)\n    return cb(null, res.result)\n  })\n}\n\nWeb3ProviderEngine.prototype._handleAsync = function(payload, finished) {\n  var self = this\n  var currentProvider = -1\n  var result = null\n  var error = null\n\n  var stack = []\n\n  next()\n\n  function next(after) {\n    currentProvider += 1\n    stack.unshift(after)\n\n    // Bubbled down as far as we could go, and the request wasn't\n    // handled. Return an error.\n    if (currentProvider >= self._providers.length) {\n      end(new Error('Request for method \"' + payload.method + '\" not handled by any subprovider. Please check your subprovider configuration to ensure this method is handled.'))\n    } else {\n      try {\n        var provider = self._providers[currentProvider]\n        provider.handleRequest(payload, next, end)\n      } catch (e) {\n        end(e)\n      }\n    }\n  }\n\n  function end(_error, _result) {\n    error = _error\n    result = _result\n\n    eachSeries(stack, function(fn, callback) {\n\n      if (fn) {\n        fn(error, result, callback)\n      } else {\n        callback()\n      }\n    }, function() {\n\n      var resultObj = {\n        id: payload.id,\n        jsonrpc: payload.jsonrpc,\n        result: result\n      }\n\n      if (error != null) {\n        resultObj.error = {\n          message: error.stack || error.message || error,\n          code: -32000\n        }\n        // respond with both error formats\n        finished(error, resultObj)\n      } else {\n        finished(null, resultObj)\n      }\n    })\n  }\n}\n\n//\n// from remote-data\n//\n\nWeb3ProviderEngine.prototype._setCurrentBlock = function(block){\n  const self = this\n  self.currentBlock = block\n  self.emit('block', block)\n}\n\n// util\n\nfunction toBufferBlock (jsonBlock) {\n  return {\n    number:           ethUtil.toBuffer(jsonBlock.number),\n    hash:             ethUtil.toBuffer(jsonBlock.hash),\n    parentHash:       ethUtil.toBuffer(jsonBlock.parentHash),\n    nonce:            ethUtil.toBuffer(jsonBlock.nonce),\n    mixHash:          ethUtil.toBuffer(jsonBlock.mixHash),\n    sha3Uncles:       ethUtil.toBuffer(jsonBlock.sha3Uncles),\n    logsBloom:        ethUtil.toBuffer(jsonBlock.logsBloom),\n    transactionsRoot: ethUtil.toBuffer(jsonBlock.transactionsRoot),\n    stateRoot:        ethUtil.toBuffer(jsonBlock.stateRoot),\n    receiptsRoot:     ethUtil.toBuffer(jsonBlock.receiptRoot || jsonBlock.receiptsRoot),\n    miner:            ethUtil.toBuffer(jsonBlock.miner),\n    difficulty:       ethUtil.toBuffer(jsonBlock.difficulty),\n    totalDifficulty:  ethUtil.toBuffer(jsonBlock.totalDifficulty),\n    size:             ethUtil.toBuffer(jsonBlock.size),\n    extraData:        ethUtil.toBuffer(jsonBlock.extraData),\n    gasLimit:         ethUtil.toBuffer(jsonBlock.gasLimit),\n    gasUsed:          ethUtil.toBuffer(jsonBlock.gasUsed),\n    timestamp:        ethUtil.toBuffer(jsonBlock.timestamp),\n    transactions:     jsonBlock.transactions,\n  }\n}\n"]},"metadata":{},"sourceType":"script"}