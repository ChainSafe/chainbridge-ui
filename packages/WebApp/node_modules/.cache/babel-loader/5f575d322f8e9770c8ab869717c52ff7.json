{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nexports.__esModule = true;\nexports.clearTimeout = exports.dispose = exports.postMessage = exports.init = exports.messagePromises = exports.error = exports.timeout = exports.initPromise = exports.origin = exports.instance = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _deferred = require(\"../utils/deferred\");\n\nvar _constants = require(\"../constants\");\n\nvar _networkUtils = require(\"../env/browser/networkUtils\");\n\nvar _inlineStyles = _interopRequireDefault(require(\"./inline-styles\"));\n\nvar instance;\nexports.instance = instance;\nvar origin;\nexports.origin = origin;\nvar initPromise = (0, _deferred.create)();\nexports.initPromise = initPromise;\nvar timeout = 0;\nexports.timeout = timeout;\nvar error;\nexports.error = error;\nvar _messageID = 0; // every postMessage to iframe has its own promise to resolve\n\nvar messagePromises = {};\nexports.messagePromises = messagePromises;\n\nvar init = /*#__PURE__*/function () {\n  var _ref = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(settings) {\n    var existedFrame, src, manifestString, manifest, onLoad;\n    return _regenerator[\"default\"].wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            exports.initPromise = initPromise = (0, _deferred.create)();\n            existedFrame = document.getElementById('trezorconnect');\n\n            if (existedFrame) {\n              exports.instance = instance = existedFrame;\n            } else {\n              exports.instance = instance = document.createElement('iframe');\n              instance.frameBorder = '0';\n              instance.width = '0px';\n              instance.height = '0px';\n              instance.style.position = 'absolute';\n              instance.style.display = 'none';\n              instance.style.border = '0px';\n              instance.style.width = '0px';\n              instance.style.height = '0px';\n              instance.id = 'trezorconnect';\n            }\n\n            if (settings.env === 'web') {\n              manifestString = settings.manifest ? JSON.stringify(settings.manifest) : 'undefined'; // note: btoa(undefined) === btoa('undefined') === \"dW5kZWZpbmVk\"\n\n              manifest = \"version=\" + settings.version + \"&manifest=\" + encodeURIComponent(btoa(JSON.stringify(manifestString)));\n              src = settings.iframeSrc + \"?\" + manifest;\n            } else {\n              src = settings.iframeSrc;\n            }\n\n            instance.setAttribute('src', src);\n\n            if (settings.webusb) {\n              instance.setAttribute('allow', 'usb');\n            }\n\n            exports.origin = origin = (0, _networkUtils.getOrigin)(instance.src);\n            exports.timeout = timeout = window.setTimeout(function () {\n              initPromise.reject(_constants.ERRORS.TypedError('Init_IframeTimeout'));\n            }, 10000);\n\n            onLoad = function onLoad() {\n              if (!instance) {\n                initPromise.reject(_constants.ERRORS.TypedError('Init_IframeBlocked'));\n                return;\n              }\n\n              try {\n                // if hosting page is able to access cross-origin location it means that the iframe is not loaded\n                var iframeOrigin = instance.contentWindow.location.origin;\n\n                if (!iframeOrigin || iframeOrigin === 'null') {\n                  // eslint-disable-next-line no-use-before-define\n                  handleIframeBlocked();\n                  return;\n                }\n              } catch (e) {// empty\n              }\n\n              var extension; // $FlowIssue chrome is not declared outside\n\n              if (typeof chrome !== 'undefined' && chrome.runtime && typeof chrome.runtime.onConnect !== 'undefined') {\n                chrome.runtime.onConnect.addListener(function () {});\n                extension = chrome.runtime.id;\n              }\n\n              instance.contentWindow.postMessage({\n                type: _constants.IFRAME.INIT,\n                payload: {\n                  settings: settings,\n                  extension: extension\n                }\n              }, origin);\n              instance.onload = undefined;\n            }; // IE hack\n\n\n            if (instance.attachEvent) {\n              instance.attachEvent('onload', onLoad);\n            } else {\n              instance.onload = onLoad;\n            } // inject iframe into host document body\n\n\n            if (document.body) {\n              document.body.appendChild(instance); // eslint-disable-next-line no-use-before-define\n\n              injectStyleSheet();\n            }\n\n            _context.prev = 11;\n            _context.next = 14;\n            return initPromise.promise;\n\n          case 14:\n            _context.next = 20;\n            break;\n\n          case 16:\n            _context.prev = 16;\n            _context.t0 = _context[\"catch\"](11); // reset state to allow initialization again\n\n            if (instance) {\n              if (instance.parentNode) {\n                instance.parentNode.removeChild(instance);\n              } // eslint-disable-next-line require-atomic-updates\n\n\n              exports.instance = instance = null;\n            }\n\n            throw _context.t0;\n\n          case 20:\n            _context.prev = 20;\n            window.clearTimeout(timeout);\n            exports.timeout = timeout = 0;\n            return _context.finish(20);\n\n          case 24:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee, null, [[11, 16, 20, 24]]);\n  }));\n\n  return function init(_x) {\n    return _ref.apply(this, arguments);\n  };\n}();\n\nexports.init = init;\n\nvar injectStyleSheet = function injectStyleSheet() {\n  if (!instance) {\n    throw _constants.ERRORS.TypedError('Init_IframeBlocked');\n  }\n\n  var doc = instance.ownerDocument;\n  var head = doc.head || doc.getElementsByTagName('head')[0];\n  var style = document.createElement('style');\n  style.setAttribute('type', 'text/css');\n  style.setAttribute('id', 'TrezorConnectStylesheet'); // $FlowIssue\n\n  if (style.styleSheet) {\n    // IE\n    // $FlowIssue\n    style.styleSheet.cssText = _inlineStyles[\"default\"];\n    head.appendChild(style);\n  } else {\n    style.appendChild(document.createTextNode(_inlineStyles[\"default\"]));\n    head.append(style);\n  }\n};\n\nvar handleIframeBlocked = function handleIframeBlocked() {\n  window.clearTimeout(timeout);\n  exports.error = error = _constants.ERRORS.TypedError('Init_IframeBlocked'); // eslint-disable-next-line no-use-before-define\n\n  dispose();\n  initPromise.reject(error);\n}; // post messages to iframe\n\n\nvar postMessage = function postMessage(message, usePromise) {\n  if (usePromise === void 0) {\n    usePromise = true;\n  }\n\n  if (!instance) {\n    throw _constants.ERRORS.TypedError('Init_IframeBlocked');\n  }\n\n  if (usePromise) {\n    _messageID++;\n    message.id = _messageID;\n    messagePromises[_messageID] = (0, _deferred.create)();\n    var promise = messagePromises[_messageID].promise;\n    instance.contentWindow.postMessage(message, origin);\n    return promise;\n  }\n\n  instance.contentWindow.postMessage(message, origin);\n  return null;\n};\n\nexports.postMessage = postMessage;\n\nvar dispose = function dispose() {\n  if (instance && instance.parentNode) {\n    try {\n      instance.parentNode.removeChild(instance);\n    } catch (error) {// do nothing\n    }\n  }\n\n  exports.instance = instance = null;\n  exports.timeout = timeout = 0;\n};\n\nexports.dispose = dispose;\n\nvar clearTimeout = function clearTimeout() {\n  window.clearTimeout(timeout);\n};\n\nexports.clearTimeout = clearTimeout;","map":{"version":3,"sources":["/home/ryann/Documents/Repos/ChainSafe/chainbridge-ui/node_modules/trezor-connect/lib/iframe/builder.js"],"names":["_interopRequireDefault","require","exports","__esModule","clearTimeout","dispose","postMessage","init","messagePromises","error","timeout","initPromise","origin","instance","_regenerator","_asyncToGenerator2","_deferred","_constants","_networkUtils","_inlineStyles","create","_messageID","_ref","mark","_callee","settings","existedFrame","src","manifestString","manifest","onLoad","wrap","_callee$","_context","prev","next","document","getElementById","createElement","frameBorder","width","height","style","position","display","border","id","env","JSON","stringify","version","encodeURIComponent","btoa","iframeSrc","setAttribute","webusb","getOrigin","window","setTimeout","reject","ERRORS","TypedError","iframeOrigin","contentWindow","location","handleIframeBlocked","e","extension","chrome","runtime","onConnect","addListener","type","IFRAME","INIT","payload","onload","undefined","attachEvent","body","appendChild","injectStyleSheet","promise","t0","parentNode","removeChild","finish","stop","_x","apply","arguments","doc","ownerDocument","head","getElementsByTagName","styleSheet","cssText","createTextNode","append","message","usePromise"],"mappings":"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","sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nexports.__esModule = true;\nexports.clearTimeout = exports.dispose = exports.postMessage = exports.init = exports.messagePromises = exports.error = exports.timeout = exports.initPromise = exports.origin = exports.instance = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _deferred = require(\"../utils/deferred\");\n\nvar _constants = require(\"../constants\");\n\nvar _networkUtils = require(\"../env/browser/networkUtils\");\n\nvar _inlineStyles = _interopRequireDefault(require(\"./inline-styles\"));\n\nvar instance;\nexports.instance = instance;\nvar origin;\nexports.origin = origin;\nvar initPromise = (0, _deferred.create)();\nexports.initPromise = initPromise;\nvar timeout = 0;\nexports.timeout = timeout;\nvar error;\nexports.error = error;\nvar _messageID = 0; // every postMessage to iframe has its own promise to resolve\n\nvar messagePromises = {};\nexports.messagePromises = messagePromises;\n\nvar init = /*#__PURE__*/function () {\n  var _ref = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(settings) {\n    var existedFrame, src, manifestString, manifest, onLoad;\n    return _regenerator[\"default\"].wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            exports.initPromise = initPromise = (0, _deferred.create)();\n            existedFrame = document.getElementById('trezorconnect');\n\n            if (existedFrame) {\n              exports.instance = instance = existedFrame;\n            } else {\n              exports.instance = instance = document.createElement('iframe');\n              instance.frameBorder = '0';\n              instance.width = '0px';\n              instance.height = '0px';\n              instance.style.position = 'absolute';\n              instance.style.display = 'none';\n              instance.style.border = '0px';\n              instance.style.width = '0px';\n              instance.style.height = '0px';\n              instance.id = 'trezorconnect';\n            }\n\n            if (settings.env === 'web') {\n              manifestString = settings.manifest ? JSON.stringify(settings.manifest) : 'undefined'; // note: btoa(undefined) === btoa('undefined') === \"dW5kZWZpbmVk\"\n\n              manifest = \"version=\" + settings.version + \"&manifest=\" + encodeURIComponent(btoa(JSON.stringify(manifestString)));\n              src = settings.iframeSrc + \"?\" + manifest;\n            } else {\n              src = settings.iframeSrc;\n            }\n\n            instance.setAttribute('src', src);\n\n            if (settings.webusb) {\n              instance.setAttribute('allow', 'usb');\n            }\n\n            exports.origin = origin = (0, _networkUtils.getOrigin)(instance.src);\n            exports.timeout = timeout = window.setTimeout(function () {\n              initPromise.reject(_constants.ERRORS.TypedError('Init_IframeTimeout'));\n            }, 10000);\n\n            onLoad = function onLoad() {\n              if (!instance) {\n                initPromise.reject(_constants.ERRORS.TypedError('Init_IframeBlocked'));\n                return;\n              }\n\n              try {\n                // if hosting page is able to access cross-origin location it means that the iframe is not loaded\n                var iframeOrigin = instance.contentWindow.location.origin;\n\n                if (!iframeOrigin || iframeOrigin === 'null') {\n                  // eslint-disable-next-line no-use-before-define\n                  handleIframeBlocked();\n                  return;\n                }\n              } catch (e) {// empty\n              }\n\n              var extension; // $FlowIssue chrome is not declared outside\n\n              if (typeof chrome !== 'undefined' && chrome.runtime && typeof chrome.runtime.onConnect !== 'undefined') {\n                chrome.runtime.onConnect.addListener(function () {});\n                extension = chrome.runtime.id;\n              }\n\n              instance.contentWindow.postMessage({\n                type: _constants.IFRAME.INIT,\n                payload: {\n                  settings: settings,\n                  extension: extension\n                }\n              }, origin);\n              instance.onload = undefined;\n            }; // IE hack\n\n\n            if (instance.attachEvent) {\n              instance.attachEvent('onload', onLoad);\n            } else {\n              instance.onload = onLoad;\n            } // inject iframe into host document body\n\n\n            if (document.body) {\n              document.body.appendChild(instance); // eslint-disable-next-line no-use-before-define\n\n              injectStyleSheet();\n            }\n\n            _context.prev = 11;\n            _context.next = 14;\n            return initPromise.promise;\n\n          case 14:\n            _context.next = 20;\n            break;\n\n          case 16:\n            _context.prev = 16;\n            _context.t0 = _context[\"catch\"](11);\n\n            // reset state to allow initialization again\n            if (instance) {\n              if (instance.parentNode) {\n                instance.parentNode.removeChild(instance);\n              } // eslint-disable-next-line require-atomic-updates\n\n\n              exports.instance = instance = null;\n            }\n\n            throw _context.t0;\n\n          case 20:\n            _context.prev = 20;\n            window.clearTimeout(timeout);\n            exports.timeout = timeout = 0;\n            return _context.finish(20);\n\n          case 24:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee, null, [[11, 16, 20, 24]]);\n  }));\n\n  return function init(_x) {\n    return _ref.apply(this, arguments);\n  };\n}();\n\nexports.init = init;\n\nvar injectStyleSheet = function injectStyleSheet() {\n  if (!instance) {\n    throw _constants.ERRORS.TypedError('Init_IframeBlocked');\n  }\n\n  var doc = instance.ownerDocument;\n  var head = doc.head || doc.getElementsByTagName('head')[0];\n  var style = document.createElement('style');\n  style.setAttribute('type', 'text/css');\n  style.setAttribute('id', 'TrezorConnectStylesheet'); // $FlowIssue\n\n  if (style.styleSheet) {\n    // IE\n    // $FlowIssue\n    style.styleSheet.cssText = _inlineStyles[\"default\"];\n    head.appendChild(style);\n  } else {\n    style.appendChild(document.createTextNode(_inlineStyles[\"default\"]));\n    head.append(style);\n  }\n};\n\nvar handleIframeBlocked = function handleIframeBlocked() {\n  window.clearTimeout(timeout);\n  exports.error = error = _constants.ERRORS.TypedError('Init_IframeBlocked'); // eslint-disable-next-line no-use-before-define\n\n  dispose();\n  initPromise.reject(error);\n}; // post messages to iframe\n\n\nvar postMessage = function postMessage(message, usePromise) {\n  if (usePromise === void 0) {\n    usePromise = true;\n  }\n\n  if (!instance) {\n    throw _constants.ERRORS.TypedError('Init_IframeBlocked');\n  }\n\n  if (usePromise) {\n    _messageID++;\n    message.id = _messageID;\n    messagePromises[_messageID] = (0, _deferred.create)();\n    var promise = messagePromises[_messageID].promise;\n    instance.contentWindow.postMessage(message, origin);\n    return promise;\n  }\n\n  instance.contentWindow.postMessage(message, origin);\n  return null;\n};\n\nexports.postMessage = postMessage;\n\nvar dispose = function dispose() {\n  if (instance && instance.parentNode) {\n    try {\n      instance.parentNode.removeChild(instance);\n    } catch (error) {// do nothing\n    }\n  }\n\n  exports.instance = instance = null;\n  exports.timeout = timeout = 0;\n};\n\nexports.dispose = dispose;\n\nvar clearTimeout = function clearTimeout() {\n  window.clearTimeout(timeout);\n};\n\nexports.clearTimeout = clearTimeout;"]},"metadata":{},"sourceType":"script"}