{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireWildcard = require(\"@babel/runtime/helpers/interopRequireWildcard\");\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nexports.__esModule = true;\nexports[\"default\"] = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _assertThisInitialized2 = _interopRequireDefault(require(\"@babel/runtime/helpers/assertThisInitialized\"));\n\nvar _inheritsLoose2 = _interopRequireDefault(require(\"@babel/runtime/helpers/inheritsLoose\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _events = _interopRequireDefault(require(\"events\"));\n\nvar POPUP = _interopRequireWildcard(require(\"../constants/popup\"));\n\nvar IFRAME = _interopRequireWildcard(require(\"../constants/iframe\"));\n\nvar UI = _interopRequireWildcard(require(\"../constants/ui\"));\n\nvar _showPopupRequest = require(\"./showPopupRequest\");\n\nvar _networkUtils = require(\"../env/browser/networkUtils\");\n\nvar _deferred = require(\"../utils/deferred\"); // const POPUP_REQUEST_TIMEOUT: number = 602;\n\n\nvar POPUP_REQUEST_TIMEOUT = 850;\nvar POPUP_CLOSE_INTERVAL = 500;\nvar POPUP_OPEN_TIMEOUT = 3000;\n\nvar PopupManager = /*#__PURE__*/function (_EventEmitter) {\n  (0, _inheritsLoose2[\"default\"])(PopupManager, _EventEmitter); // Window\n\n  function PopupManager(settings) {\n    var _this;\n\n    _this = _EventEmitter.call(this) || this;\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"requestTimeout\", 0);\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"closeInterval\", 0);\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"extensionTabId\", 0);\n    _this.settings = settings;\n    _this.origin = (0, _networkUtils.getOrigin)(settings.popupSrc);\n    _this.handleMessage = _this.handleMessage.bind((0, _assertThisInitialized2[\"default\"])(_this));\n    _this.iframeHandshake = (0, _deferred.create)(IFRAME.LOADED);\n\n    if (_this.settings.env === 'webextension') {\n      _this.handleExtensionConnect = _this.handleExtensionConnect.bind((0, _assertThisInitialized2[\"default\"])(_this));\n      _this.handleExtensionMessage = _this.handleExtensionMessage.bind((0, _assertThisInitialized2[\"default\"])(_this)); // $FlowIssue chrome not declared outside\n\n      chrome.runtime.onConnect.addListener(_this.handleExtensionConnect);\n    }\n\n    window.addEventListener('message', _this.handleMessage, false);\n    return _this;\n  }\n\n  var _proto = PopupManager.prototype;\n\n  _proto.request = function request(lazyLoad) {\n    var _this2 = this;\n\n    if (lazyLoad === void 0) {\n      lazyLoad = false;\n    } // popup request\n    // TODO: ie - open immediately and hide it but post handshake after timeout\n    // bring popup window to front\n\n\n    if (this.locked) {\n      if (this._window) {\n        if (this.settings.env === 'webextension') {\n          // $FlowIssue chrome not declared outside\n          chrome.tabs.update(this._window.id, {\n            active: true\n          });\n        } else {\n          this._window.focus();\n        }\n      }\n\n      return;\n    }\n\n    var openFn = this.open.bind(this);\n    this.locked = true;\n\n    if (!this.settings.supportedBrowser) {\n      openFn();\n    } else {\n      var timeout = lazyLoad || this.settings.env === 'webextension' ? 1 : POPUP_REQUEST_TIMEOUT;\n      this.requestTimeout = window.setTimeout(function () {\n        _this2.requestTimeout = 0;\n        openFn(lazyLoad);\n      }, timeout);\n    }\n  };\n\n  _proto.cancel = function cancel() {\n    this.close();\n  };\n\n  _proto.unlock = function unlock() {\n    this.locked = false;\n  };\n\n  _proto.open = function open(lazyLoad) {\n    var _this3 = this;\n\n    var src = this.settings.popupSrc;\n\n    if (!this.settings.supportedBrowser) {\n      this.openWrapper(src + \"#unsupported\");\n      return;\n    }\n\n    this.popupPromise = (0, _deferred.create)(POPUP.LOADED);\n    this.openWrapper(lazyLoad ? src + \"#loading\" : src);\n    this.closeInterval = window.setInterval(function () {\n      if (!_this3._window) return;\n\n      if (_this3.settings.env === 'webextension') {\n        // $FlowIssue chrome not declared outside\n        chrome.tabs.get(_this3._window.id, function (tab) {\n          if (!tab) {\n            _this3.close();\n\n            _this3.emit(POPUP.CLOSED);\n          }\n        });\n      } else if (_this3._window.closed) {\n        _this3.close();\n\n        _this3.emit(POPUP.CLOSED);\n      }\n    }, POPUP_CLOSE_INTERVAL); // open timeout will be cancelled by POPUP.BOOTSTRAP message\n\n    this.openTimeout = window.setTimeout(function () {\n      _this3.close();\n\n      (0, _showPopupRequest.showPopupRequest)(_this3.open.bind(_this3), function () {\n        _this3.emit(POPUP.CLOSED);\n      });\n    }, POPUP_OPEN_TIMEOUT);\n  };\n\n  _proto.openWrapper = function openWrapper(url) {\n    var _this4 = this;\n\n    if (this.settings.env === 'webextension') {\n      // $FlowIssue chrome not declared outside\n      chrome.windows.getCurrent(null, function (currentWindow) {\n        // Request coming from extension popup,\n        // create new window above instead of opening new tab\n        if (currentWindow.type !== 'normal') {\n          // $FlowIssue chrome not declared outside\n          chrome.windows.create({\n            url: url\n          }, function (newWindow) {\n            // $FlowIssue chrome not declared outside\n            chrome.tabs.query({\n              windowId: newWindow.id,\n              active: true\n            }, function (tabs) {\n              _this4._window = tabs[0];\n            });\n          });\n        } else {\n          // $FlowIssue chrome not declared outside\n          chrome.tabs.query({\n            currentWindow: true,\n            active: true\n          }, function (tabs) {\n            _this4.extensionTabId = tabs[0].id; // $FlowIssue chrome not declared outside\n\n            chrome.tabs.create({\n              url: url,\n              index: tabs[0].index + 1\n            }, function (tab) {\n              _this4._window = tab;\n            });\n          });\n        }\n      });\n    } else if (this.settings.env === 'electron') {\n      this._window = window.open(url, 'modal');\n    } else {\n      this._window = window.open('', '_blank');\n\n      if (this._window) {\n        this._window.location.href = url; // otherwise android/chrome loose window.opener reference\n      }\n    }\n  };\n\n  _proto.handleExtensionConnect = function handleExtensionConnect(port) {\n    if (port.name !== 'trezor-connect') return;\n\n    if (!this._window || this._window && this._window.id !== port.sender.tab.id) {\n      port.disconnect();\n      return;\n    } // since POPUP.BOOTSTRAP will not be handled by \"handleMessage\" we need to threat \"content-script\" connection as the same event\n    // popup is opened properly, now wait for POPUP.LOADED message (in this case handled by \"handleExtensionMessage\")\n\n\n    window.clearTimeout(this.openTimeout);\n    this.extensionPort = port; // $FlowIssue need to update ChromePort definition\n\n    this.extensionPort.onMessage.addListener(this.handleExtensionMessage);\n  };\n\n  _proto.handleExtensionMessage = function handleExtensionMessage(message) {\n    var _this5 = this;\n\n    if (!this.extensionPort) return;\n    var port = this.extensionPort;\n    var data = message.data;\n    if (!data || typeof data !== 'object') return;\n\n    if (data.type === POPUP.ERROR) {\n      // handle popup error\n      var errorMessage = data.payload && typeof data.payload.error === 'string' ? data.payload.error : null;\n      this.emit(POPUP.CLOSED, errorMessage ? \"Popup error: \" + errorMessage : null);\n      this.close();\n    } else if (data.type === POPUP.LOADED) {\n      if (this.popupPromise) {\n        this.popupPromise.resolve();\n      }\n\n      this.iframeHandshake.promise.then(function () {\n        port.postMessage({\n          type: POPUP.INIT,\n          payload: {\n            settings: _this5.settings\n          }\n        });\n      });\n    } else if (data.type === POPUP.EXTENSION_USB_PERMISSIONS) {\n      // $FlowIssue chrome not declared outside\n      chrome.tabs.query({\n        currentWindow: true,\n        active: true\n      }, function (tabs) {\n        // $FlowIssue chrome not declared outside\n        chrome.tabs.create({\n          url: 'trezor-usb-permissions.html',\n          index: tabs[0].index + 1\n        }, function (tab) {// do nothing\n        });\n      });\n    } else if (data.type === POPUP.CLOSE_WINDOW) {\n      this.emit(POPUP.CLOSED);\n      this.close();\n    }\n  };\n\n  _proto.handleMessage = function handleMessage(message) {\n    var _this6 = this; // ignore messages from domain other then popup origin and without data\n\n\n    var data = message.data;\n    if ((0, _networkUtils.getOrigin)(message.origin) !== this.origin || !data || typeof data !== 'object') return;\n\n    if (data.type === IFRAME.LOADED) {\n      this.iframeHandshake.resolve();\n    } else if (data.type === POPUP.BOOTSTRAP) {\n      // popup is opened properly, now wait for POPUP.LOADED message\n      window.clearTimeout(this.openTimeout);\n    } else if (data.type === POPUP.ERROR && this._window) {\n      var errorMessage = data.payload && typeof data.payload.error === 'string' ? data.payload.error : null;\n      this.emit(POPUP.CLOSED, errorMessage ? \"Popup error: \" + errorMessage : null);\n      this.close();\n    } else if (data.type === POPUP.LOADED) {\n      if (this.popupPromise) {\n        this.popupPromise.resolve();\n      } // popup is successfully loaded\n\n\n      this.iframeHandshake.promise.then(function () {\n        _this6._window.postMessage({\n          type: POPUP.INIT,\n          payload: {\n            settings: _this6.settings\n          }\n        }, _this6.origin);\n      }); // send ConnectSettings to popup\n      // note this settings and iframe.ConnectSettings could be different (especially: origin, popup, webusb, debug)\n      // now popup is able to load assets\n    } else if (data.type === POPUP.CANCEL_POPUP_REQUEST || data.type === UI.CLOSE_UI_WINDOW) {\n      this.close();\n    }\n  };\n\n  _proto.close = function close() {\n    this.locked = false;\n    this.popupPromise = undefined;\n\n    if (this.requestTimeout) {\n      window.clearTimeout(this.requestTimeout);\n      this.requestTimeout = 0;\n    }\n\n    if (this.openTimeout) {\n      window.clearTimeout(this.openTimeout);\n      this.openTimeout = 0;\n    }\n\n    if (this.closeInterval) {\n      window.clearInterval(this.closeInterval);\n      this.closeInterval = 0;\n    }\n\n    if (this.extensionPort) {\n      this.extensionPort.disconnect();\n      this.extensionPort = null;\n    } // switch to previously focused tab\n\n\n    if (this.extensionTabId) {\n      // $FlowIssue chrome not declared outside\n      chrome.tabs.update(this.extensionTabId, {\n        active: true\n      });\n      this.extensionTabId = 0;\n    }\n\n    if (this._window) {\n      if (this.settings.env === 'webextension') {\n        // eslint-disable-next-line no-unused-vars\n        var _e = chrome.runtime.lastError; // $FlowIssue chrome not declared outside\n\n        chrome.tabs.remove(this._window.id, function () {\n          // eslint-disable-next-line no-unused-vars\n          _e = chrome.runtime.lastError;\n        });\n      } else {\n        this._window.close();\n      }\n\n      this._window = null;\n    }\n  };\n\n  _proto.postMessage = /*#__PURE__*/function () {\n    var _postMessage = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(message) {\n      var _this7 = this;\n\n      return _regenerator[\"default\"].wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              if (!(!this._window && message.type !== UI.REQUEST_UI_WINDOW && this.openTimeout)) {\n                _context.next = 4;\n                break;\n              }\n\n              this.close();\n              (0, _showPopupRequest.showPopupRequest)(this.open.bind(this), function () {\n                _this7.emit(POPUP.CLOSED);\n              });\n              return _context.abrupt(\"return\");\n\n            case 4:\n              if (!this.popupPromise) {\n                _context.next = 7;\n                break;\n              }\n\n              _context.next = 7;\n              return this.popupPromise.promise;\n\n            case 7:\n              // post message to popup window\n              if (this._window) {\n                this._window.postMessage(message, this.origin);\n              }\n\n            case 8:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, this);\n    }));\n\n    function postMessage(_x) {\n      return _postMessage.apply(this, arguments);\n    }\n\n    return postMessage;\n  }();\n\n  _proto.onBeforeUnload = function onBeforeUnload() {\n    this.close();\n  };\n\n  return PopupManager;\n}(_events[\"default\"]);\n\nexports[\"default\"] = PopupManager;","map":{"version":3,"sources":["/home/ryann/Documents/Repos/ChainSafe/chainbridge-ui/node_modules/trezor-connect/lib/popup/PopupManager.js"],"names":["_interopRequireWildcard","require","_interopRequireDefault","exports","__esModule","_regenerator","_asyncToGenerator2","_assertThisInitialized2","_inheritsLoose2","_defineProperty2","_events","POPUP","IFRAME","UI","_showPopupRequest","_networkUtils","_deferred","POPUP_REQUEST_TIMEOUT","POPUP_CLOSE_INTERVAL","POPUP_OPEN_TIMEOUT","PopupManager","_EventEmitter","settings","_this","call","origin","getOrigin","popupSrc","handleMessage","bind","iframeHandshake","create","LOADED","env","handleExtensionConnect","handleExtensionMessage","chrome","runtime","onConnect","addListener","window","addEventListener","_proto","prototype","request","lazyLoad","_this2","locked","_window","tabs","update","id","active","focus","openFn","open","supportedBrowser","timeout","requestTimeout","setTimeout","cancel","close","unlock","_this3","src","openWrapper","popupPromise","closeInterval","setInterval","get","tab","emit","CLOSED","closed","openTimeout","showPopupRequest","url","_this4","windows","getCurrent","currentWindow","type","newWindow","query","windowId","extensionTabId","index","location","href","port","name","sender","disconnect","clearTimeout","extensionPort","onMessage","message","_this5","data","ERROR","errorMessage","payload","error","resolve","promise","then","postMessage","INIT","EXTENSION_USB_PERMISSIONS","CLOSE_WINDOW","_this6","BOOTSTRAP","CANCEL_POPUP_REQUEST","CLOSE_UI_WINDOW","undefined","clearInterval","_e","lastError","remove","_postMessage","mark","_callee","_this7","wrap","_callee$","_context","prev","next","REQUEST_UI_WINDOW","abrupt","stop","_x","apply","arguments","onBeforeUnload"],"mappings":"AAAA;;AAEA,IAAIA,uBAAuB,GAAGC,OAAO,CAAC,+CAAD,CAArC;;AAEA,IAAIC,sBAAsB,GAAGD,OAAO,CAAC,8CAAD,CAApC;;AAEAE,OAAO,CAACC,UAAR,GAAqB,IAArB;AACAD,OAAO,CAAC,SAAD,CAAP,GAAqB,KAAK,CAA1B;;AAEA,IAAIE,YAAY,GAAGH,sBAAsB,CAACD,OAAO,CAAC,4BAAD,CAAR,CAAzC;;AAEA,IAAIK,kBAAkB,GAAGJ,sBAAsB,CAACD,OAAO,CAAC,yCAAD,CAAR,CAA/C;;AAEA,IAAIM,uBAAuB,GAAGL,sBAAsB,CAACD,OAAO,CAAC,8CAAD,CAAR,CAApD;;AAEA,IAAIO,eAAe,GAAGN,sBAAsB,CAACD,OAAO,CAAC,sCAAD,CAAR,CAA5C;;AAEA,IAAIQ,gBAAgB,GAAGP,sBAAsB,CAACD,OAAO,CAAC,uCAAD,CAAR,CAA7C;;AAEA,IAAIS,OAAO,GAAGR,sBAAsB,CAACD,OAAO,CAAC,QAAD,CAAR,CAApC;;AAEA,IAAIU,KAAK,GAAGX,uBAAuB,CAACC,OAAO,CAAC,oBAAD,CAAR,CAAnC;;AAEA,IAAIW,MAAM,GAAGZ,uBAAuB,CAACC,OAAO,CAAC,qBAAD,CAAR,CAApC;;AAEA,IAAIY,EAAE,GAAGb,uBAAuB,CAACC,OAAO,CAAC,iBAAD,CAAR,CAAhC;;AAEA,IAAIa,iBAAiB,GAAGb,OAAO,CAAC,oBAAD,CAA/B;;AAEA,IAAIc,aAAa,GAAGd,OAAO,CAAC,6BAAD,CAA3B;;AAEA,IAAIe,SAAS,GAAGf,OAAO,CAAC,mBAAD,CAAvB,C,CAEA;;;AACA,IAAIgB,qBAAqB,GAAG,GAA5B;AACA,IAAIC,oBAAoB,GAAG,GAA3B;AACA,IAAIC,kBAAkB,GAAG,IAAzB;;AAEA,IAAIC,YAAY,GAAG,aAAa,UAAUC,aAAV,EAAyB;AACvD,GAAC,GAAGb,eAAe,CAAC,SAAD,CAAnB,EAAgCY,YAAhC,EAA8CC,aAA9C,EADuD,CAGvD;;AACA,WAASD,YAAT,CAAsBE,QAAtB,EAAgC;AAC9B,QAAIC,KAAJ;;AAEAA,IAAAA,KAAK,GAAGF,aAAa,CAACG,IAAd,CAAmB,IAAnB,KAA4B,IAApC;AACA,KAAC,GAAGf,gBAAgB,CAAC,SAAD,CAApB,EAAiC,CAAC,GAAGF,uBAAuB,CAAC,SAAD,CAA3B,EAAwCgB,KAAxC,CAAjC,EAAiF,gBAAjF,EAAmG,CAAnG;AACA,KAAC,GAAGd,gBAAgB,CAAC,SAAD,CAApB,EAAiC,CAAC,GAAGF,uBAAuB,CAAC,SAAD,CAA3B,EAAwCgB,KAAxC,CAAjC,EAAiF,eAAjF,EAAkG,CAAlG;AACA,KAAC,GAAGd,gBAAgB,CAAC,SAAD,CAApB,EAAiC,CAAC,GAAGF,uBAAuB,CAAC,SAAD,CAA3B,EAAwCgB,KAAxC,CAAjC,EAAiF,gBAAjF,EAAmG,CAAnG;AACAA,IAAAA,KAAK,CAACD,QAAN,GAAiBA,QAAjB;AACAC,IAAAA,KAAK,CAACE,MAAN,GAAe,CAAC,GAAGV,aAAa,CAACW,SAAlB,EAA6BJ,QAAQ,CAACK,QAAtC,CAAf;AACAJ,IAAAA,KAAK,CAACK,aAAN,GAAsBL,KAAK,CAACK,aAAN,CAAoBC,IAApB,CAAyB,CAAC,GAAGtB,uBAAuB,CAAC,SAAD,CAA3B,EAAwCgB,KAAxC,CAAzB,CAAtB;AACAA,IAAAA,KAAK,CAACO,eAAN,GAAwB,CAAC,GAAGd,SAAS,CAACe,MAAd,EAAsBnB,MAAM,CAACoB,MAA7B,CAAxB;;AAEA,QAAIT,KAAK,CAACD,QAAN,CAAeW,GAAf,KAAuB,cAA3B,EAA2C;AACzCV,MAAAA,KAAK,CAACW,sBAAN,GAA+BX,KAAK,CAACW,sBAAN,CAA6BL,IAA7B,CAAkC,CAAC,GAAGtB,uBAAuB,CAAC,SAAD,CAA3B,EAAwCgB,KAAxC,CAAlC,CAA/B;AACAA,MAAAA,KAAK,CAACY,sBAAN,GAA+BZ,KAAK,CAACY,sBAAN,CAA6BN,IAA7B,CAAkC,CAAC,GAAGtB,uBAAuB,CAAC,SAAD,CAA3B,EAAwCgB,KAAxC,CAAlC,CAA/B,CAFyC,CAEyE;;AAElHa,MAAAA,MAAM,CAACC,OAAP,CAAeC,SAAf,CAAyBC,WAAzB,CAAqChB,KAAK,CAACW,sBAA3C;AACD;;AAEDM,IAAAA,MAAM,CAACC,gBAAP,CAAwB,SAAxB,EAAmClB,KAAK,CAACK,aAAzC,EAAwD,KAAxD;AACA,WAAOL,KAAP;AACD;;AAED,MAAImB,MAAM,GAAGtB,YAAY,CAACuB,SAA1B;;AAEAD,EAAAA,MAAM,CAACE,OAAP,GAAiB,SAASA,OAAT,CAAiBC,QAAjB,EAA2B;AAC1C,QAAIC,MAAM,GAAG,IAAb;;AAEA,QAAID,QAAQ,KAAK,KAAK,CAAtB,EAAyB;AACvBA,MAAAA,QAAQ,GAAG,KAAX;AACD,KALyC,CAO1C;AACA;AACA;;;AACA,QAAI,KAAKE,MAAT,EAAiB;AACf,UAAI,KAAKC,OAAT,EAAkB;AAChB,YAAI,KAAK1B,QAAL,CAAcW,GAAd,KAAsB,cAA1B,EAA0C;AACxC;AACAG,UAAAA,MAAM,CAACa,IAAP,CAAYC,MAAZ,CAAmB,KAAKF,OAAL,CAAaG,EAAhC,EAAoC;AAClCC,YAAAA,MAAM,EAAE;AAD0B,WAApC;AAGD,SALD,MAKO;AACL,eAAKJ,OAAL,CAAaK,KAAb;AACD;AACF;;AAED;AACD;;AAED,QAAIC,MAAM,GAAG,KAAKC,IAAL,CAAU1B,IAAV,CAAe,IAAf,CAAb;AACA,SAAKkB,MAAL,GAAc,IAAd;;AAEA,QAAI,CAAC,KAAKzB,QAAL,CAAckC,gBAAnB,EAAqC;AACnCF,MAAAA,MAAM;AACP,KAFD,MAEO;AACL,UAAIG,OAAO,GAAGZ,QAAQ,IAAI,KAAKvB,QAAL,CAAcW,GAAd,KAAsB,cAAlC,GAAmD,CAAnD,GAAuDhB,qBAArE;AACA,WAAKyC,cAAL,GAAsBlB,MAAM,CAACmB,UAAP,CAAkB,YAAY;AAClDb,QAAAA,MAAM,CAACY,cAAP,GAAwB,CAAxB;AACAJ,QAAAA,MAAM,CAACT,QAAD,CAAN;AACD,OAHqB,EAGnBY,OAHmB,CAAtB;AAID;AACF,GArCD;;AAuCAf,EAAAA,MAAM,CAACkB,MAAP,GAAgB,SAASA,MAAT,GAAkB;AAChC,SAAKC,KAAL;AACD,GAFD;;AAIAnB,EAAAA,MAAM,CAACoB,MAAP,GAAgB,SAASA,MAAT,GAAkB;AAChC,SAAKf,MAAL,GAAc,KAAd;AACD,GAFD;;AAIAL,EAAAA,MAAM,CAACa,IAAP,GAAc,SAASA,IAAT,CAAcV,QAAd,EAAwB;AACpC,QAAIkB,MAAM,GAAG,IAAb;;AAEA,QAAIC,GAAG,GAAG,KAAK1C,QAAL,CAAcK,QAAxB;;AAEA,QAAI,CAAC,KAAKL,QAAL,CAAckC,gBAAnB,EAAqC;AACnC,WAAKS,WAAL,CAAiBD,GAAG,GAAG,cAAvB;AACA;AACD;;AAED,SAAKE,YAAL,GAAoB,CAAC,GAAGlD,SAAS,CAACe,MAAd,EAAsBpB,KAAK,CAACqB,MAA5B,CAApB;AACA,SAAKiC,WAAL,CAAiBpB,QAAQ,GAAGmB,GAAG,GAAG,UAAT,GAAsBA,GAA/C;AACA,SAAKG,aAAL,GAAqB3B,MAAM,CAAC4B,WAAP,CAAmB,YAAY;AAClD,UAAI,CAACL,MAAM,CAACf,OAAZ,EAAqB;;AAErB,UAAIe,MAAM,CAACzC,QAAP,CAAgBW,GAAhB,KAAwB,cAA5B,EAA4C;AAC1C;AACAG,QAAAA,MAAM,CAACa,IAAP,CAAYoB,GAAZ,CAAgBN,MAAM,CAACf,OAAP,CAAeG,EAA/B,EAAmC,UAAUmB,GAAV,EAAe;AAChD,cAAI,CAACA,GAAL,EAAU;AACRP,YAAAA,MAAM,CAACF,KAAP;;AAEAE,YAAAA,MAAM,CAACQ,IAAP,CAAY5D,KAAK,CAAC6D,MAAlB;AACD;AACF,SAND;AAOD,OATD,MASO,IAAIT,MAAM,CAACf,OAAP,CAAeyB,MAAnB,EAA2B;AAChCV,QAAAA,MAAM,CAACF,KAAP;;AAEAE,QAAAA,MAAM,CAACQ,IAAP,CAAY5D,KAAK,CAAC6D,MAAlB;AACD;AACF,KAjBoB,EAiBlBtD,oBAjBkB,CAArB,CAZoC,CA6BV;;AAE1B,SAAKwD,WAAL,GAAmBlC,MAAM,CAACmB,UAAP,CAAkB,YAAY;AAC/CI,MAAAA,MAAM,CAACF,KAAP;;AAEA,OAAC,GAAG/C,iBAAiB,CAAC6D,gBAAtB,EAAwCZ,MAAM,CAACR,IAAP,CAAY1B,IAAZ,CAAiBkC,MAAjB,CAAxC,EAAkE,YAAY;AAC5EA,QAAAA,MAAM,CAACQ,IAAP,CAAY5D,KAAK,CAAC6D,MAAlB;AACD,OAFD;AAGD,KANkB,EAMhBrD,kBANgB,CAAnB;AAOD,GAtCD;;AAwCAuB,EAAAA,MAAM,CAACuB,WAAP,GAAqB,SAASA,WAAT,CAAqBW,GAArB,EAA0B;AAC7C,QAAIC,MAAM,GAAG,IAAb;;AAEA,QAAI,KAAKvD,QAAL,CAAcW,GAAd,KAAsB,cAA1B,EAA0C;AACxC;AACAG,MAAAA,MAAM,CAAC0C,OAAP,CAAeC,UAAf,CAA0B,IAA1B,EAAgC,UAAUC,aAAV,EAAyB;AACvD;AACA;AACA,YAAIA,aAAa,CAACC,IAAd,KAAuB,QAA3B,EAAqC;AACnC;AACA7C,UAAAA,MAAM,CAAC0C,OAAP,CAAe/C,MAAf,CAAsB;AACpB6C,YAAAA,GAAG,EAAEA;AADe,WAAtB,EAEG,UAAUM,SAAV,EAAqB;AACtB;AACA9C,YAAAA,MAAM,CAACa,IAAP,CAAYkC,KAAZ,CAAkB;AAChBC,cAAAA,QAAQ,EAAEF,SAAS,CAAC/B,EADJ;AAEhBC,cAAAA,MAAM,EAAE;AAFQ,aAAlB,EAGG,UAAUH,IAAV,EAAgB;AACjB4B,cAAAA,MAAM,CAAC7B,OAAP,GAAiBC,IAAI,CAAC,CAAD,CAArB;AACD,aALD;AAMD,WAVD;AAWD,SAbD,MAaO;AACL;AACAb,UAAAA,MAAM,CAACa,IAAP,CAAYkC,KAAZ,CAAkB;AAChBH,YAAAA,aAAa,EAAE,IADC;AAEhB5B,YAAAA,MAAM,EAAE;AAFQ,WAAlB,EAGG,UAAUH,IAAV,EAAgB;AACjB4B,YAAAA,MAAM,CAACQ,cAAP,GAAwBpC,IAAI,CAAC,CAAD,CAAJ,CAAQE,EAAhC,CADiB,CACmB;;AAEpCf,YAAAA,MAAM,CAACa,IAAP,CAAYlB,MAAZ,CAAmB;AACjB6C,cAAAA,GAAG,EAAEA,GADY;AAEjBU,cAAAA,KAAK,EAAErC,IAAI,CAAC,CAAD,CAAJ,CAAQqC,KAAR,GAAgB;AAFN,aAAnB,EAGG,UAAUhB,GAAV,EAAe;AAChBO,cAAAA,MAAM,CAAC7B,OAAP,GAAiBsB,GAAjB;AACD,aALD;AAMD,WAZD;AAaD;AACF,OAhCD;AAiCD,KAnCD,MAmCO,IAAI,KAAKhD,QAAL,CAAcW,GAAd,KAAsB,UAA1B,EAAsC;AAC3C,WAAKe,OAAL,GAAeR,MAAM,CAACe,IAAP,CAAYqB,GAAZ,EAAiB,OAAjB,CAAf;AACD,KAFM,MAEA;AACL,WAAK5B,OAAL,GAAeR,MAAM,CAACe,IAAP,CAAY,EAAZ,EAAgB,QAAhB,CAAf;;AAEA,UAAI,KAAKP,OAAT,EAAkB;AAChB,aAAKA,OAAL,CAAauC,QAAb,CAAsBC,IAAtB,GAA6BZ,GAA7B,CADgB,CACkB;AACnC;AACF;AACF,GA/CD;;AAiDAlC,EAAAA,MAAM,CAACR,sBAAP,GAAgC,SAASA,sBAAT,CAAgCuD,IAAhC,EAAsC;AACpE,QAAIA,IAAI,CAACC,IAAL,KAAc,gBAAlB,EAAoC;;AAEpC,QAAI,CAAC,KAAK1C,OAAN,IAAiB,KAAKA,OAAL,IAAgB,KAAKA,OAAL,CAAaG,EAAb,KAAoBsC,IAAI,CAACE,MAAL,CAAYrB,GAAZ,CAAgBnB,EAAzE,EAA6E;AAC3EsC,MAAAA,IAAI,CAACG,UAAL;AACA;AACD,KANmE,CAMlE;AACF;;;AAGApD,IAAAA,MAAM,CAACqD,YAAP,CAAoB,KAAKnB,WAAzB;AACA,SAAKoB,aAAL,GAAqBL,IAArB,CAXoE,CAWzC;;AAE3B,SAAKK,aAAL,CAAmBC,SAAnB,CAA6BxD,WAA7B,CAAyC,KAAKJ,sBAA9C;AACD,GAdD;;AAgBAO,EAAAA,MAAM,CAACP,sBAAP,GAAgC,SAASA,sBAAT,CAAgC6D,OAAhC,EAAyC;AACvE,QAAIC,MAAM,GAAG,IAAb;;AAEA,QAAI,CAAC,KAAKH,aAAV,EAAyB;AACzB,QAAIL,IAAI,GAAG,KAAKK,aAAhB;AACA,QAAII,IAAI,GAAGF,OAAO,CAACE,IAAnB;AACA,QAAI,CAACA,IAAD,IAAS,OAAOA,IAAP,KAAgB,QAA7B,EAAuC;;AAEvC,QAAIA,IAAI,CAACjB,IAAL,KAActE,KAAK,CAACwF,KAAxB,EAA+B;AAC7B;AACA,UAAIC,YAAY,GAAGF,IAAI,CAACG,OAAL,IAAgB,OAAOH,IAAI,CAACG,OAAL,CAAaC,KAApB,KAA8B,QAA9C,GAAyDJ,IAAI,CAACG,OAAL,CAAaC,KAAtE,GAA8E,IAAjG;AACA,WAAK/B,IAAL,CAAU5D,KAAK,CAAC6D,MAAhB,EAAwB4B,YAAY,GAAG,kBAAkBA,YAArB,GAAoC,IAAxE;AACA,WAAKvC,KAAL;AACD,KALD,MAKO,IAAIqC,IAAI,CAACjB,IAAL,KAActE,KAAK,CAACqB,MAAxB,EAAgC;AACrC,UAAI,KAAKkC,YAAT,EAAuB;AACrB,aAAKA,YAAL,CAAkBqC,OAAlB;AACD;;AAED,WAAKzE,eAAL,CAAqB0E,OAArB,CAA6BC,IAA7B,CAAkC,YAAY;AAC5ChB,QAAAA,IAAI,CAACiB,WAAL,CAAiB;AACfzB,UAAAA,IAAI,EAAEtE,KAAK,CAACgG,IADG;AAEfN,UAAAA,OAAO,EAAE;AACP/E,YAAAA,QAAQ,EAAE2E,MAAM,CAAC3E;AADV;AAFM,SAAjB;AAMD,OAPD;AAQD,KAbM,MAaA,IAAI4E,IAAI,CAACjB,IAAL,KAActE,KAAK,CAACiG,yBAAxB,EAAmD;AACxD;AACAxE,MAAAA,MAAM,CAACa,IAAP,CAAYkC,KAAZ,CAAkB;AAChBH,QAAAA,aAAa,EAAE,IADC;AAEhB5B,QAAAA,MAAM,EAAE;AAFQ,OAAlB,EAGG,UAAUH,IAAV,EAAgB;AACjB;AACAb,QAAAA,MAAM,CAACa,IAAP,CAAYlB,MAAZ,CAAmB;AACjB6C,UAAAA,GAAG,EAAE,6BADY;AAEjBU,UAAAA,KAAK,EAAErC,IAAI,CAAC,CAAD,CAAJ,CAAQqC,KAAR,GAAgB;AAFN,SAAnB,EAGG,UAAUhB,GAAV,EAAe,CAAC;AAClB,SAJD;AAKD,OAVD;AAWD,KAbM,MAaA,IAAI4B,IAAI,CAACjB,IAAL,KAActE,KAAK,CAACkG,YAAxB,EAAsC;AAC3C,WAAKtC,IAAL,CAAU5D,KAAK,CAAC6D,MAAhB;AACA,WAAKX,KAAL;AACD;AACF,GA3CD;;AA6CAnB,EAAAA,MAAM,CAACd,aAAP,GAAuB,SAASA,aAAT,CAAuBoE,OAAvB,EAAgC;AACrD,QAAIc,MAAM,GAAG,IAAb,CADqD,CAGrD;;;AACA,QAAIZ,IAAI,GAAGF,OAAO,CAACE,IAAnB;AACA,QAAI,CAAC,GAAGnF,aAAa,CAACW,SAAlB,EAA6BsE,OAAO,CAACvE,MAArC,MAAiD,KAAKA,MAAtD,IAAgE,CAACyE,IAAjE,IAAyE,OAAOA,IAAP,KAAgB,QAA7F,EAAuG;;AAEvG,QAAIA,IAAI,CAACjB,IAAL,KAAcrE,MAAM,CAACoB,MAAzB,EAAiC;AAC/B,WAAKF,eAAL,CAAqByE,OAArB;AACD,KAFD,MAEO,IAAIL,IAAI,CAACjB,IAAL,KAActE,KAAK,CAACoG,SAAxB,EAAmC;AACxC;AACAvE,MAAAA,MAAM,CAACqD,YAAP,CAAoB,KAAKnB,WAAzB;AACD,KAHM,MAGA,IAAIwB,IAAI,CAACjB,IAAL,KAActE,KAAK,CAACwF,KAApB,IAA6B,KAAKnD,OAAtC,EAA+C;AACpD,UAAIoD,YAAY,GAAGF,IAAI,CAACG,OAAL,IAAgB,OAAOH,IAAI,CAACG,OAAL,CAAaC,KAApB,KAA8B,QAA9C,GAAyDJ,IAAI,CAACG,OAAL,CAAaC,KAAtE,GAA8E,IAAjG;AACA,WAAK/B,IAAL,CAAU5D,KAAK,CAAC6D,MAAhB,EAAwB4B,YAAY,GAAG,kBAAkBA,YAArB,GAAoC,IAAxE;AACA,WAAKvC,KAAL;AACD,KAJM,MAIA,IAAIqC,IAAI,CAACjB,IAAL,KAActE,KAAK,CAACqB,MAAxB,EAAgC;AACrC,UAAI,KAAKkC,YAAT,EAAuB;AACrB,aAAKA,YAAL,CAAkBqC,OAAlB;AACD,OAHoC,CAGnC;;;AAGF,WAAKzE,eAAL,CAAqB0E,OAArB,CAA6BC,IAA7B,CAAkC,YAAY;AAC5CK,QAAAA,MAAM,CAAC9D,OAAP,CAAe0D,WAAf,CAA2B;AACzBzB,UAAAA,IAAI,EAAEtE,KAAK,CAACgG,IADa;AAEzBN,UAAAA,OAAO,EAAE;AACP/E,YAAAA,QAAQ,EAAEwF,MAAM,CAACxF;AADV;AAFgB,SAA3B,EAKGwF,MAAM,CAACrF,MALV;AAMD,OAPD,EANqC,CAajC;AACJ;AACA;AACD,KAhBM,MAgBA,IAAIyE,IAAI,CAACjB,IAAL,KAActE,KAAK,CAACqG,oBAApB,IAA4Cd,IAAI,CAACjB,IAAL,KAAcpE,EAAE,CAACoG,eAAjE,EAAkF;AACvF,WAAKpD,KAAL;AACD;AACF,GAnCD;;AAqCAnB,EAAAA,MAAM,CAACmB,KAAP,GAAe,SAASA,KAAT,GAAiB;AAC9B,SAAKd,MAAL,GAAc,KAAd;AACA,SAAKmB,YAAL,GAAoBgD,SAApB;;AAEA,QAAI,KAAKxD,cAAT,EAAyB;AACvBlB,MAAAA,MAAM,CAACqD,YAAP,CAAoB,KAAKnC,cAAzB;AACA,WAAKA,cAAL,GAAsB,CAAtB;AACD;;AAED,QAAI,KAAKgB,WAAT,EAAsB;AACpBlC,MAAAA,MAAM,CAACqD,YAAP,CAAoB,KAAKnB,WAAzB;AACA,WAAKA,WAAL,GAAmB,CAAnB;AACD;;AAED,QAAI,KAAKP,aAAT,EAAwB;AACtB3B,MAAAA,MAAM,CAAC2E,aAAP,CAAqB,KAAKhD,aAA1B;AACA,WAAKA,aAAL,GAAqB,CAArB;AACD;;AAED,QAAI,KAAK2B,aAAT,EAAwB;AACtB,WAAKA,aAAL,CAAmBF,UAAnB;AACA,WAAKE,aAAL,GAAqB,IAArB;AACD,KAtB6B,CAsB5B;;;AAGF,QAAI,KAAKT,cAAT,EAAyB;AACvB;AACAjD,MAAAA,MAAM,CAACa,IAAP,CAAYC,MAAZ,CAAmB,KAAKmC,cAAxB,EAAwC;AACtCjC,QAAAA,MAAM,EAAE;AAD8B,OAAxC;AAGA,WAAKiC,cAAL,GAAsB,CAAtB;AACD;;AAED,QAAI,KAAKrC,OAAT,EAAkB;AAChB,UAAI,KAAK1B,QAAL,CAAcW,GAAd,KAAsB,cAA1B,EAA0C;AACxC;AACA,YAAImF,EAAE,GAAGhF,MAAM,CAACC,OAAP,CAAegF,SAAxB,CAFwC,CAEL;;AAEnCjF,QAAAA,MAAM,CAACa,IAAP,CAAYqE,MAAZ,CAAmB,KAAKtE,OAAL,CAAaG,EAAhC,EAAoC,YAAY;AAC9C;AACAiE,UAAAA,EAAE,GAAGhF,MAAM,CAACC,OAAP,CAAegF,SAApB;AACD,SAHD;AAID,OARD,MAQO;AACL,aAAKrE,OAAL,CAAaa,KAAb;AACD;;AAED,WAAKb,OAAL,GAAe,IAAf;AACD;AACF,GAhDD;;AAkDAN,EAAAA,MAAM,CAACgE,WAAP,GAAqB,aAAa,YAAY;AAC5C,QAAIa,YAAY,GAAG,CAAC,GAAGjH,kBAAkB,CAAC,SAAD,CAAtB,GAAoC,aAAaD,YAAY,CAAC,SAAD,CAAZ,CAAwBmH,IAAxB,CAA6B,SAASC,OAAT,CAAiBzB,OAAjB,EAA0B;AACzH,UAAI0B,MAAM,GAAG,IAAb;;AAEA,aAAOrH,YAAY,CAAC,SAAD,CAAZ,CAAwBsH,IAAxB,CAA6B,SAASC,QAAT,CAAkBC,QAAlB,EAA4B;AAC9D,eAAO,CAAP,EAAU;AACR,kBAAQA,QAAQ,CAACC,IAAT,GAAgBD,QAAQ,CAACE,IAAjC;AACE,iBAAK,CAAL;AACE,kBAAI,EAAE,CAAC,KAAK/E,OAAN,IAAiBgD,OAAO,CAACf,IAAR,KAAiBpE,EAAE,CAACmH,iBAArC,IAA0D,KAAKtD,WAAjE,CAAJ,EAAmF;AACjFmD,gBAAAA,QAAQ,CAACE,IAAT,GAAgB,CAAhB;AACA;AACD;;AAED,mBAAKlE,KAAL;AACA,eAAC,GAAG/C,iBAAiB,CAAC6D,gBAAtB,EAAwC,KAAKpB,IAAL,CAAU1B,IAAV,CAAe,IAAf,CAAxC,EAA8D,YAAY;AACxE6F,gBAAAA,MAAM,CAACnD,IAAP,CAAY5D,KAAK,CAAC6D,MAAlB;AACD,eAFD;AAGA,qBAAOqD,QAAQ,CAACI,MAAT,CAAgB,QAAhB,CAAP;;AAEF,iBAAK,CAAL;AACE,kBAAI,CAAC,KAAK/D,YAAV,EAAwB;AACtB2D,gBAAAA,QAAQ,CAACE,IAAT,GAAgB,CAAhB;AACA;AACD;;AAEDF,cAAAA,QAAQ,CAACE,IAAT,GAAgB,CAAhB;AACA,qBAAO,KAAK7D,YAAL,CAAkBsC,OAAzB;;AAEF,iBAAK,CAAL;AACE;AACA,kBAAI,KAAKxD,OAAT,EAAkB;AAChB,qBAAKA,OAAL,CAAa0D,WAAb,CAAyBV,OAAzB,EAAkC,KAAKvE,MAAvC;AACD;;AAEH,iBAAK,CAAL;AACA,iBAAK,KAAL;AACE,qBAAOoG,QAAQ,CAACK,IAAT,EAAP;AA9BJ;AAgCD;AACF,OAnCM,EAmCJT,OAnCI,EAmCK,IAnCL,CAAP;AAoCD,KAvCmE,CAAjD,CAAnB;;AAyCA,aAASf,WAAT,CAAqByB,EAArB,EAAyB;AACvB,aAAOZ,YAAY,CAACa,KAAb,CAAmB,IAAnB,EAAyBC,SAAzB,CAAP;AACD;;AAED,WAAO3B,WAAP;AACD,GA/CiC,EAAlC;;AAiDAhE,EAAAA,MAAM,CAAC4F,cAAP,GAAwB,SAASA,cAAT,GAA0B;AAChD,SAAKzE,KAAL;AACD,GAFD;;AAIA,SAAOzC,YAAP;AACD,CA/W+B,CA+W9BV,OAAO,CAAC,SAAD,CA/WuB,CAAhC;;AAiXAP,OAAO,CAAC,SAAD,CAAP,GAAqBiB,YAArB","sourcesContent":["\"use strict\";\n\nvar _interopRequireWildcard = require(\"@babel/runtime/helpers/interopRequireWildcard\");\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nexports.__esModule = true;\nexports[\"default\"] = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _assertThisInitialized2 = _interopRequireDefault(require(\"@babel/runtime/helpers/assertThisInitialized\"));\n\nvar _inheritsLoose2 = _interopRequireDefault(require(\"@babel/runtime/helpers/inheritsLoose\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _events = _interopRequireDefault(require(\"events\"));\n\nvar POPUP = _interopRequireWildcard(require(\"../constants/popup\"));\n\nvar IFRAME = _interopRequireWildcard(require(\"../constants/iframe\"));\n\nvar UI = _interopRequireWildcard(require(\"../constants/ui\"));\n\nvar _showPopupRequest = require(\"./showPopupRequest\");\n\nvar _networkUtils = require(\"../env/browser/networkUtils\");\n\nvar _deferred = require(\"../utils/deferred\");\n\n// const POPUP_REQUEST_TIMEOUT: number = 602;\nvar POPUP_REQUEST_TIMEOUT = 850;\nvar POPUP_CLOSE_INTERVAL = 500;\nvar POPUP_OPEN_TIMEOUT = 3000;\n\nvar PopupManager = /*#__PURE__*/function (_EventEmitter) {\n  (0, _inheritsLoose2[\"default\"])(PopupManager, _EventEmitter);\n\n  // Window\n  function PopupManager(settings) {\n    var _this;\n\n    _this = _EventEmitter.call(this) || this;\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"requestTimeout\", 0);\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"closeInterval\", 0);\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"extensionTabId\", 0);\n    _this.settings = settings;\n    _this.origin = (0, _networkUtils.getOrigin)(settings.popupSrc);\n    _this.handleMessage = _this.handleMessage.bind((0, _assertThisInitialized2[\"default\"])(_this));\n    _this.iframeHandshake = (0, _deferred.create)(IFRAME.LOADED);\n\n    if (_this.settings.env === 'webextension') {\n      _this.handleExtensionConnect = _this.handleExtensionConnect.bind((0, _assertThisInitialized2[\"default\"])(_this));\n      _this.handleExtensionMessage = _this.handleExtensionMessage.bind((0, _assertThisInitialized2[\"default\"])(_this)); // $FlowIssue chrome not declared outside\n\n      chrome.runtime.onConnect.addListener(_this.handleExtensionConnect);\n    }\n\n    window.addEventListener('message', _this.handleMessage, false);\n    return _this;\n  }\n\n  var _proto = PopupManager.prototype;\n\n  _proto.request = function request(lazyLoad) {\n    var _this2 = this;\n\n    if (lazyLoad === void 0) {\n      lazyLoad = false;\n    }\n\n    // popup request\n    // TODO: ie - open immediately and hide it but post handshake after timeout\n    // bring popup window to front\n    if (this.locked) {\n      if (this._window) {\n        if (this.settings.env === 'webextension') {\n          // $FlowIssue chrome not declared outside\n          chrome.tabs.update(this._window.id, {\n            active: true\n          });\n        } else {\n          this._window.focus();\n        }\n      }\n\n      return;\n    }\n\n    var openFn = this.open.bind(this);\n    this.locked = true;\n\n    if (!this.settings.supportedBrowser) {\n      openFn();\n    } else {\n      var timeout = lazyLoad || this.settings.env === 'webextension' ? 1 : POPUP_REQUEST_TIMEOUT;\n      this.requestTimeout = window.setTimeout(function () {\n        _this2.requestTimeout = 0;\n        openFn(lazyLoad);\n      }, timeout);\n    }\n  };\n\n  _proto.cancel = function cancel() {\n    this.close();\n  };\n\n  _proto.unlock = function unlock() {\n    this.locked = false;\n  };\n\n  _proto.open = function open(lazyLoad) {\n    var _this3 = this;\n\n    var src = this.settings.popupSrc;\n\n    if (!this.settings.supportedBrowser) {\n      this.openWrapper(src + \"#unsupported\");\n      return;\n    }\n\n    this.popupPromise = (0, _deferred.create)(POPUP.LOADED);\n    this.openWrapper(lazyLoad ? src + \"#loading\" : src);\n    this.closeInterval = window.setInterval(function () {\n      if (!_this3._window) return;\n\n      if (_this3.settings.env === 'webextension') {\n        // $FlowIssue chrome not declared outside\n        chrome.tabs.get(_this3._window.id, function (tab) {\n          if (!tab) {\n            _this3.close();\n\n            _this3.emit(POPUP.CLOSED);\n          }\n        });\n      } else if (_this3._window.closed) {\n        _this3.close();\n\n        _this3.emit(POPUP.CLOSED);\n      }\n    }, POPUP_CLOSE_INTERVAL); // open timeout will be cancelled by POPUP.BOOTSTRAP message\n\n    this.openTimeout = window.setTimeout(function () {\n      _this3.close();\n\n      (0, _showPopupRequest.showPopupRequest)(_this3.open.bind(_this3), function () {\n        _this3.emit(POPUP.CLOSED);\n      });\n    }, POPUP_OPEN_TIMEOUT);\n  };\n\n  _proto.openWrapper = function openWrapper(url) {\n    var _this4 = this;\n\n    if (this.settings.env === 'webextension') {\n      // $FlowIssue chrome not declared outside\n      chrome.windows.getCurrent(null, function (currentWindow) {\n        // Request coming from extension popup,\n        // create new window above instead of opening new tab\n        if (currentWindow.type !== 'normal') {\n          // $FlowIssue chrome not declared outside\n          chrome.windows.create({\n            url: url\n          }, function (newWindow) {\n            // $FlowIssue chrome not declared outside\n            chrome.tabs.query({\n              windowId: newWindow.id,\n              active: true\n            }, function (tabs) {\n              _this4._window = tabs[0];\n            });\n          });\n        } else {\n          // $FlowIssue chrome not declared outside\n          chrome.tabs.query({\n            currentWindow: true,\n            active: true\n          }, function (tabs) {\n            _this4.extensionTabId = tabs[0].id; // $FlowIssue chrome not declared outside\n\n            chrome.tabs.create({\n              url: url,\n              index: tabs[0].index + 1\n            }, function (tab) {\n              _this4._window = tab;\n            });\n          });\n        }\n      });\n    } else if (this.settings.env === 'electron') {\n      this._window = window.open(url, 'modal');\n    } else {\n      this._window = window.open('', '_blank');\n\n      if (this._window) {\n        this._window.location.href = url; // otherwise android/chrome loose window.opener reference\n      }\n    }\n  };\n\n  _proto.handleExtensionConnect = function handleExtensionConnect(port) {\n    if (port.name !== 'trezor-connect') return;\n\n    if (!this._window || this._window && this._window.id !== port.sender.tab.id) {\n      port.disconnect();\n      return;\n    } // since POPUP.BOOTSTRAP will not be handled by \"handleMessage\" we need to threat \"content-script\" connection as the same event\n    // popup is opened properly, now wait for POPUP.LOADED message (in this case handled by \"handleExtensionMessage\")\n\n\n    window.clearTimeout(this.openTimeout);\n    this.extensionPort = port; // $FlowIssue need to update ChromePort definition\n\n    this.extensionPort.onMessage.addListener(this.handleExtensionMessage);\n  };\n\n  _proto.handleExtensionMessage = function handleExtensionMessage(message) {\n    var _this5 = this;\n\n    if (!this.extensionPort) return;\n    var port = this.extensionPort;\n    var data = message.data;\n    if (!data || typeof data !== 'object') return;\n\n    if (data.type === POPUP.ERROR) {\n      // handle popup error\n      var errorMessage = data.payload && typeof data.payload.error === 'string' ? data.payload.error : null;\n      this.emit(POPUP.CLOSED, errorMessage ? \"Popup error: \" + errorMessage : null);\n      this.close();\n    } else if (data.type === POPUP.LOADED) {\n      if (this.popupPromise) {\n        this.popupPromise.resolve();\n      }\n\n      this.iframeHandshake.promise.then(function () {\n        port.postMessage({\n          type: POPUP.INIT,\n          payload: {\n            settings: _this5.settings\n          }\n        });\n      });\n    } else if (data.type === POPUP.EXTENSION_USB_PERMISSIONS) {\n      // $FlowIssue chrome not declared outside\n      chrome.tabs.query({\n        currentWindow: true,\n        active: true\n      }, function (tabs) {\n        // $FlowIssue chrome not declared outside\n        chrome.tabs.create({\n          url: 'trezor-usb-permissions.html',\n          index: tabs[0].index + 1\n        }, function (tab) {// do nothing\n        });\n      });\n    } else if (data.type === POPUP.CLOSE_WINDOW) {\n      this.emit(POPUP.CLOSED);\n      this.close();\n    }\n  };\n\n  _proto.handleMessage = function handleMessage(message) {\n    var _this6 = this;\n\n    // ignore messages from domain other then popup origin and without data\n    var data = message.data;\n    if ((0, _networkUtils.getOrigin)(message.origin) !== this.origin || !data || typeof data !== 'object') return;\n\n    if (data.type === IFRAME.LOADED) {\n      this.iframeHandshake.resolve();\n    } else if (data.type === POPUP.BOOTSTRAP) {\n      // popup is opened properly, now wait for POPUP.LOADED message\n      window.clearTimeout(this.openTimeout);\n    } else if (data.type === POPUP.ERROR && this._window) {\n      var errorMessage = data.payload && typeof data.payload.error === 'string' ? data.payload.error : null;\n      this.emit(POPUP.CLOSED, errorMessage ? \"Popup error: \" + errorMessage : null);\n      this.close();\n    } else if (data.type === POPUP.LOADED) {\n      if (this.popupPromise) {\n        this.popupPromise.resolve();\n      } // popup is successfully loaded\n\n\n      this.iframeHandshake.promise.then(function () {\n        _this6._window.postMessage({\n          type: POPUP.INIT,\n          payload: {\n            settings: _this6.settings\n          }\n        }, _this6.origin);\n      }); // send ConnectSettings to popup\n      // note this settings and iframe.ConnectSettings could be different (especially: origin, popup, webusb, debug)\n      // now popup is able to load assets\n    } else if (data.type === POPUP.CANCEL_POPUP_REQUEST || data.type === UI.CLOSE_UI_WINDOW) {\n      this.close();\n    }\n  };\n\n  _proto.close = function close() {\n    this.locked = false;\n    this.popupPromise = undefined;\n\n    if (this.requestTimeout) {\n      window.clearTimeout(this.requestTimeout);\n      this.requestTimeout = 0;\n    }\n\n    if (this.openTimeout) {\n      window.clearTimeout(this.openTimeout);\n      this.openTimeout = 0;\n    }\n\n    if (this.closeInterval) {\n      window.clearInterval(this.closeInterval);\n      this.closeInterval = 0;\n    }\n\n    if (this.extensionPort) {\n      this.extensionPort.disconnect();\n      this.extensionPort = null;\n    } // switch to previously focused tab\n\n\n    if (this.extensionTabId) {\n      // $FlowIssue chrome not declared outside\n      chrome.tabs.update(this.extensionTabId, {\n        active: true\n      });\n      this.extensionTabId = 0;\n    }\n\n    if (this._window) {\n      if (this.settings.env === 'webextension') {\n        // eslint-disable-next-line no-unused-vars\n        var _e = chrome.runtime.lastError; // $FlowIssue chrome not declared outside\n\n        chrome.tabs.remove(this._window.id, function () {\n          // eslint-disable-next-line no-unused-vars\n          _e = chrome.runtime.lastError;\n        });\n      } else {\n        this._window.close();\n      }\n\n      this._window = null;\n    }\n  };\n\n  _proto.postMessage = /*#__PURE__*/function () {\n    var _postMessage = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(message) {\n      var _this7 = this;\n\n      return _regenerator[\"default\"].wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              if (!(!this._window && message.type !== UI.REQUEST_UI_WINDOW && this.openTimeout)) {\n                _context.next = 4;\n                break;\n              }\n\n              this.close();\n              (0, _showPopupRequest.showPopupRequest)(this.open.bind(this), function () {\n                _this7.emit(POPUP.CLOSED);\n              });\n              return _context.abrupt(\"return\");\n\n            case 4:\n              if (!this.popupPromise) {\n                _context.next = 7;\n                break;\n              }\n\n              _context.next = 7;\n              return this.popupPromise.promise;\n\n            case 7:\n              // post message to popup window\n              if (this._window) {\n                this._window.postMessage(message, this.origin);\n              }\n\n            case 8:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, this);\n    }));\n\n    function postMessage(_x) {\n      return _postMessage.apply(this, arguments);\n    }\n\n    return postMessage;\n  }();\n\n  _proto.onBeforeUnload = function onBeforeUnload() {\n    this.close();\n  };\n\n  return PopupManager;\n}(_events[\"default\"]);\n\nexports[\"default\"] = PopupManager;"]},"metadata":{},"sourceType":"script"}